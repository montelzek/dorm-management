<app-main-layout [user]="currentUser()">
  <div class="mx-auto max-w-7xl space-y-6">
    <!-- Header -->
    <div>
      <h1 class="text-3xl font-bold text-text-primary">{{ 'events.calendar' | translate }}</h1>
      <p class="mt-1 text-text-secondary">{{ 'events.viewUpcoming' | translate }}</p>
    </div>

    <!-- Calendar Card -->
    <div class="rounded-lg bg-card shadow-sm border border-card-border p-6">

      <!-- DESKTOP VIEW (Month) -->
      <div class="hidden md:block">
        <!-- Month Navigation -->
        <div class="flex items-center justify-between mb-6">
          <button (click)="previousMonth()"
            class="px-4 py-2 text-sm cursor-pointer font-medium text-text-primary bg-background rounded-lg hover:bg-card-border transition-colors flex items-center justify-center gap-2 shadow-sm border border-card-border"
            [attr.aria-label]="'common.previous' | translate">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            {{ 'common.previous' | translate }}
          </button>

          <h2 class="text-2xl font-bold text-text-primary uppercase tracking-wide">
            {{ viewDate() | date: 'LLLL yyyy' : '' : locale }}
          </h2>

          <button (click)="nextMonth()"
            class="px-4 py-2 text-sm cursor-pointer font-medium text-text-primary bg-background rounded-lg hover:bg-card-border transition-colors flex items-center justify-center gap-2 shadow-sm border border-card-border"
            [attr.aria-label]="'common.next' | translate">
            {{ 'common.next' | translate }}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>

        @if (eventsLoading()) {
        <div class="flex justify-center items-center py-20">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        </div>
        } @else {
        <div class="calendar-container">
          <mwl-calendar-month-view [viewDate]="viewDate()" [events]="calendarEvents()"
            [cellTemplate]="customCellTemplate" [headerTemplate]="headerTemplate" [weekStartsOn]="1" [locale]="locale"
            (dayClicked)="onDayClicked($event)" (viewDateChange)="onViewDateChange($event)">
            <ng-template #headerTemplate let-days="days" let-locale="locale">
              <div class="cal-header">
                <div class="cal-cell" *ngFor="let day of days" [class.cal-past]="day.isPast"
                  [class.cal-today]="day.isToday" [class.cal-future]="day.isFuture" [class.cal-weekend]="day.isWeekend">
                  <span class="uppercase">{{ day.date | date:'EEEE':undefined:locale }}</span>
                </div>
              </div>
            </ng-template>

            <ng-template #customCellTemplate let-day="day" let-locale="locale">
              <div class="cal-cell-top">
                <span class="cal-day-number">{{ day.date | date: 'd' }}</span>
                @if (day.events.length > 0) {
                <span class="cal-day-badge">{{ day.events.length }}</span>
                }
              </div>
            </ng-template>
          </mwl-calendar-month-view>
        </div>
        }
      </div>

      <!-- MOBILE VIEW (Vertical Week) -->
      <div class="block md:hidden">
        <!-- Week Navigation -->
        <div class="flex items-center justify-between mb-6">
          <button (click)="previousWeek()"
            class="p-2 text-sm cursor-pointer font-medium text-text-primary bg-background rounded-lg hover:bg-card-border transition-colors flex items-center justify-center shadow-sm border border-card-border"
            [attr.aria-label]="'common.previous' | translate">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>

          <div class="text-center">
            <h2 class="text-lg font-bold text-text-primary uppercase tracking-wide">
              {{ viewDate() | date: 'LLLL yyyy' : '' : locale }}
            </h2>
            <p class="text-xs text-text-secondary">
              {{ currentWeekDays()[0] | date:'d MMM' : '' : locale }} - {{ currentWeekDays()[6] | date:'d MMM' : '' :
              locale }}
            </p>
          </div>


          <button (click)="nextWeek()"
            class="p-2 text-sm cursor-pointer font-medium text-text-primary bg-background rounded-lg hover:bg-card-border transition-colors flex items-center justify-center shadow-sm border border-card-border"
            [attr.aria-label]="'common.next' | translate">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>

        @if (eventsLoading()) {
        <div class="flex justify-center items-center py-10">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        </div>
        } @else {
        <div class="space-y-2">
          @for (day of currentWeekDays(); track day) {
          <div (click)="onDayClicked({ day: { date: day } })"
            class="p-4 rounded-lg border bg-background flex items-center justify-between cursor-pointer hover:bg-card transition-colors"
            [class.border-indigo-500]="(day | date:'yyyy-MM-dd') === (viewDate() | date:'yyyy-MM-dd')"
            [class.border-card-border]="(day | date:'yyyy-MM-dd') !== (viewDate() | date:'yyyy-MM-dd')">
            <div class="flex flex-col">
              <span class="text-xs font-semibold text-text-secondary uppercase">
                {{ day | date:'EEEE' : '' : locale }}
              </span>
              <span class="text-xl font-bold text-text-primary">
                {{ day | date:'d' }}
              </span>
            </div>

            @if (getEventsCountForDay(day) > 0) {
            <span class="bg-indigo-600 text-white text-xs font-bold px-2.5 py-1 rounded-full">
              {{ getEventsCountForDay(day) }}
            </span>
            }
          </div>
          }
        </div>
        }
      </div>

    </div>

    <!-- Events Details Modal -->
    @if (selectedDayEvents().length > 0) {
    <div class="fixed inset-0 z-50 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/30 backdrop-blur-sm transition-opacity" (click)="closeEventDetails()"></div>

        <!-- Modal -->
        <div class="relative bg-card rounded-lg shadow-xl max-w-2xl w-full p-6 border border-card-border">
          <div class="flex justify-between items-start mb-4">
            <h2 class="text-2xl font-bold text-text-primary">{{ 'events.eventsOnDay' | translate }} {{ selectedDate() }}
            </h2>
            <button (click)="closeEventDetails()" class="text-text-secondary hover:text-text-primary transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            @for (event of selectedDayEvents(); track event.id) {
            <div class="p-4 bg-background rounded-lg border border-card-border">
              <h3 class="text-lg font-semibold text-text-primary mb-2">{{ event.title }}</h3>

              <div class="space-y-2">
                <div>
                  <span class="text-sm font-medium text-text-secondary">{{ 'table.time' | translate }}: </span>
                  <span class="text-sm text-text-primary">{{ event.startTime }} - {{ event.endTime }}</span>
                </div>

                @if (event.building) {
                <div>
                  <span class="text-sm font-medium text-text-secondary">{{ 'events.eventLocation' | translate }}:
                  </span>
                  <span class="text-sm text-text-primary">
                    {{ event.building.name }}
                    @if (event.resource) {
                    <span>- {{ event.resource.name }}</span>
                    }
                  </span>
                </div>
                }

                @if (event.description) {
                <div>
                  <span class="text-sm font-medium text-text-secondary">{{ 'table.description' | translate }}: </span>
                  <p class="text-sm text-text-primary mt-1 whitespace-pre-wrap">{{ event.description }}</p>
                </div>
                }
              </div>
            </div>
            }
          </div>

          <div class="mt-6 flex justify-end">
            <button (click)="closeEventDetails()"
              class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors">
              {{ 'common.close' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>
    }
  </div>
</app-main-layout>