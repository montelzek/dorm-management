<app-main-layout [user]="currentUser()">
  <div class="mx-auto max-w-7xl space-y-6">
    <!-- Header -->
    <div>
      <h1 class="text-3xl font-bold text-text-primary">{{ 'admin.issuesManagement' | translate }}</h1>
      <p class="mt-1 text-text-secondary">{{ 'issues.monitorAndManage' | translate }}</p>
    </div>

    <!-- Filters -->
    <div class="rounded-lg bg-card shadow-sm border border-card-border p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Status Filter -->
        <div>
          <label for="statusFilter" class="block text-sm font-medium text-text-primary mb-1">
            {{ 'table.status' | translate }}
          </label>
          <select
            id="statusFilter"
            [value]="selectedStatusFilter()"
            (change)="onStatusFilterChange($any($event.target).value)"
            class="w-full rounded-lg border-2 border-input-border bg-input-bg px-3 py-2 text-input-text text-sm focus:border-input-focus-border focus:outline-none focus:ring-2 focus:ring-input-focus-border transition-all"
          >
            <option value="">{{ 'issues.allStatuses' | translate }}</option>
            <option value="REPORTED">{{ 'issues.status.reported' | translate }}</option>
            <option value="IN_PROGRESS">{{ 'issues.status.inProgress' | translate }}</option>
            <option value="RESOLVED">{{ 'issues.status.resolved' | translate }}</option>
            <option value="CANCELLED">{{ 'issues.status.cancelled' | translate }}</option>
          </select>
        </div>

        <!-- Priority Filter -->
        <div>
          <label for="priorityFilter" class="block text-sm font-medium text-text-primary mb-1">
            {{ 'table.priority' | translate }}
          </label>
          <select
            id="priorityFilter"
            [value]="selectedPriorityFilter()"
            (change)="onPriorityFilterChange($any($event.target).value)"
            class="w-full rounded-lg border-2 border-input-border bg-input-bg px-3 py-2 text-input-text text-sm focus:border-input-focus-border focus:outline-none focus:ring-2 focus:ring-input-focus-border transition-all"
          >
            <option value="">{{ 'issues.allPriorities' | translate }}</option>
            <option value="LOW">{{ 'issues.priority.low' | translate }}</option>
            <option value="MEDIUM">{{ 'issues.priority.medium' | translate }}</option>
            <option value="HIGH">{{ 'issues.priority.high' | translate }}</option>
            <option value="URGENT">{{ 'issues.priority.urgent' | translate }}</option>
          </select>
        </div>

        <!-- Building Filter -->
        <div>
          <label for="buildingFilter" class="block text-sm font-medium text-text-primary mb-1">
            {{ 'table.building' | translate }}
          </label>
          <select
            id="buildingFilter"
            [value]="selectedBuildingId()"
            (change)="onBuildingFilterChange($any($event.target).value)"
            class="w-full rounded-lg border-2 border-input-border bg-input-bg px-3 py-2 text-input-text text-sm focus:border-input-focus-border focus:outline-none focus:ring-2 focus:ring-input-focus-border transition-all"
          >
            <option value="">{{ 'dashboard.allBuildings' | translate }}</option>
            @for (building of buildings(); track building.id) {
              <option [value]="building.id">{{ building.name }}</option>
            }
          </select>
        </div>
      </div>
    </div>

    <!-- Issues List -->
    <div class="rounded-lg bg-card shadow-sm border border-card-border overflow-hidden">
      <!-- Top Info Bar -->
      @if (totalElements() > 0) {
        <div class="bg-surface px-6 py-3 border-b border-card-border">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="text-sm text-text-secondary">
              {{ 'common.showing' | translate }} {{ currentPage() * pageSize() + 1 }} {{ 'common.to' | translate }} 
              {{ Math.min((currentPage() + 1) * pageSize(), totalElements()) }} {{ 'common.of' | translate }} 
              {{ totalElements() }} {{ 'common.results' | translate }}
            </div>

            <div class="flex items-center gap-2">
              <label for="pageSize" class="text-sm text-text-secondary">{{ 'issues.itemsPerPage' | translate }}:</label>
              <select
                id="pageSize"
                [value]="pageSize()"
                (change)="onPageSizeChange(+$any($event.target).value)"
                class="rounded-md border-input-border bg-input-bg px-2 py-1 text-input-text text-sm focus:border-input-focus-border focus:outline-none focus:ring-2 focus:ring-input-focus-border"
              >
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>
        </div>
      }

      <!-- Issues List -->
      <app-admin-issue-list
        [issues]="allIssues()"
        [isLoading]="isLoading()"
        (cancelIssue)="onCancelIssue($event)"
        (assignTechnician)="onAssignTechnician($event)"
      ></app-admin-issue-list>

      <!-- Bottom Pagination Buttons -->
      @if (totalElements() > 0) {
        <div class="bg-surface px-6 py-4 border-t border-card-border">
          <div class="flex justify-center">
            <div class="flex gap-1">
              <button
                (click)="onPageChange(currentPage() - 1)"
                [disabled]="currentPage() === 0"
                class="px-3 py-1 rounded-md bg-card text-text-primary border border-card-border hover:bg-indigo-600 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                {{ 'common.previous' | translate }}
              </button>

              @for (pageNum of [].constructor(totalPages()); track $index) {
                @if ($index === 0 || $index === totalPages() - 1 || ($index >= currentPage() - 1 && $index <= currentPage() + 1)) {
                  <button
                    (click)="onPageChange($index)"
                    [class]="$index === currentPage() ? 'px-3 py-1 rounded-md bg-indigo-600 text-white' : 'px-3 py-1 rounded-md bg-card text-text-primary border border-card-border hover:bg-indigo-600 hover:text-white transition-colors'"
                  >
                    {{ $index + 1 }}
                  </button>
                } @else if ($index === currentPage() - 2 || $index === currentPage() + 2) {
                  <span class="px-2 py-1 text-text-secondary">...</span>
                }
              }

              <button
                (click)="onPageChange(currentPage() + 1)"
                [disabled]="currentPage() === totalPages() - 1"
                class="px-3 py-1 rounded-md bg-card text-text-primary border border-card-border hover:bg-indigo-600 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                {{ 'common.next' | translate }}
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Assign Technician Modal -->
  <app-modal
    [isOpen]="isAssignModalOpen()"
    [title]="'admin.assignTechnician' | translate"
    size="md"
    (close)="onCloseAssignModal()"
  >
    <div slot="body">
      @if (selectedIssue()) {
        <app-assign-technician-modal
          [technicians]="technicians()"
          [currentTechnicianId]="selectedIssue()!.assignedTechnician?.id || null"
          [isLoading]="isLoading()"
          (assign)="onAssignTechnicianSubmit($event)"
          (cancel)="onCloseAssignModal()"
        ></app-assign-technician-modal>
      }
    </div>
  </app-modal>

</app-main-layout>

