<app-main-layout [user]="currentUser()">
  <div class="mx-auto max-w-7xl space-y-6">
    <!-- Header -->
    <div>
      <h1 class="text-3xl font-bold text-text-primary">{{ 'technician.tasksHistory' | translate }}</h1>
      <p class="mt-1 text-text-secondary">{{ 'technician.viewCompleted' | translate }}</p>
    </div>

    <!-- Tasks List -->
    <div class="rounded-lg bg-card shadow-sm border border-card-border overflow-hidden">
      <!-- Top Info Bar -->
      @if (totalElements() > 0) {
        <div class="bg-surface px-6 py-3 border-b border-card-border">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="text-sm text-text-secondary">
              {{ 'common.showing' | translate }} {{ currentPage() * pageSize() + 1 }} {{ 'common.to' | translate }} 
              {{ Math.min((currentPage() + 1) * pageSize(), totalElements()) }} {{ 'common.of' | translate }} 
              {{ totalElements() }} {{ 'technician.tasks' | translate }}
            </div>

            <div class="flex items-center gap-2">
              <label for="pageSize" class="text-sm text-text-secondary">{{ 'issues.itemsPerPage' | translate }}:</label>
              <select
                id="pageSize"
                [value]="pageSize()"
                (change)="onPageSizeChange(+$any($event.target).value)"
                class="rounded-md border-input-border bg-input-bg px-2 py-1 text-input-text text-sm focus:border-input-focus-border focus:outline-none focus:ring-2 focus:ring-input-focus-border"
              >
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>
        </div>
      }

      <!-- Tasks List -->
      <app-task-list
        [tasks]="tasks()"
        [isLoading]="isLoading()"
        [readonly]="true"
        (viewTask)="onViewTask($event)"
      ></app-task-list>

      <!-- Bottom Pagination Buttons -->
      @if (totalElements() > 0) {
        <div class="bg-surface px-6 py-4 border-t border-card-border">
          <div class="flex justify-center">
            <div class="flex gap-1">
              <button
                (click)="onPageChange(currentPage() - 1)"
                [disabled]="currentPage() === 0"
                class="px-3 py-1 rounded-md bg-card text-text-primary border border-card-border hover:bg-indigo-600 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                {{ 'common.previous' | translate }}
              </button>

              @for (pageNum of [].constructor(totalPages()); track $index) {
                @if ($index === 0 || $index === totalPages() - 1 || ($index >= currentPage() - 1 && $index <= currentPage() + 1)) {
                  <button
                    (click)="onPageChange($index)"
                    [class]="$index === currentPage() ? 'px-3 py-1 rounded-md bg-indigo-600 text-white' : 'px-3 py-1 rounded-md bg-card text-text-primary border border-card-border hover:bg-indigo-600 hover:text-white transition-colors'"
                  >
                    {{ $index + 1 }}
                  </button>
                } @else if ($index === currentPage() - 2 || $index === currentPage() + 2) {
                  <span class="px-2 py-1 text-text-secondary">...</span>
                }
              }

              <button
                (click)="onPageChange(currentPage() + 1)"
                [disabled]="currentPage() === totalPages() - 1"
                class="px-3 py-1 rounded-md bg-card text-text-primary border border-card-border hover:bg-indigo-600 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                {{ 'common.next' | translate }}
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Task Detail Modal (Read-only for history) -->
  <app-modal
    [isOpen]="isDetailModalOpen()"
    [title]="'technician.taskDetails' | translate"
    size="lg"
    (close)="onCloseDetailModal()"
  >
    <div slot="body">
      @if (selectedTask()) {
        <div class="space-y-6">
          <!-- Task Info -->
          <div class="space-y-4">
            <div>
              <h3 class="text-lg font-semibold text-text-primary mb-2">{{ selectedTask()!.title }}</h3>
              <p class="text-sm text-text-secondary">{{ selectedTask()!.description }}</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-text-secondary mb-1">{{ 'table.status' | translate }}</label>
                <span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-medium" 
                  [ngClass]="selectedTask()!.status === 'RESOLVED' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'">
                  {{ selectedTask()!.status | titlecase }}
                </span>
              </div>
              <div>
                <label class="block text-xs font-medium text-text-secondary mb-1">{{ 'table.priority' | translate }}</label>
                <span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-medium"
                  [ngClass]="selectedTask()!.priority === 'URGENT' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : selectedTask()!.priority === 'HIGH' ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'">
                  {{ selectedTask()!.priority | titlecase }}
                </span>
              </div>
            </div>

            <div class="border-t border-card-border pt-4">
              <h4 class="text-sm font-semibold text-text-primary mb-3">{{ 'table.reporter' | translate }}</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-text-secondary">{{ 'table.name' | translate }}:</span>
                  <span class="text-text-primary font-medium">{{ selectedTask()!.user.firstName }} {{ selectedTask()!.user.lastName }}</span>
                </div>
                @if (selectedTask()!.room) {
                  <div class="flex justify-between">
                    <span class="text-text-secondary">{{ 'table.room' | translate }}:</span>
                    <span class="text-text-primary font-medium">{{ selectedTask()!.room!.roomNumber }}</span>
                  </div>
                }
                @if (selectedTask()!.building) {
                  <div class="flex justify-between">
                    <span class="text-text-secondary">{{ 'table.building' | translate }}:</span>
                    <span class="text-text-primary font-medium">{{ selectedTask()!.building!.name }}</span>
                  </div>
                }
              </div>
            </div>

            <div class="border-t border-card-border pt-4">
              <h4 class="text-sm font-semibold text-text-primary mb-3">{{ 'common.timestamps' | translate }}</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-text-secondary">{{ 'table.created' | translate }}:</span>
                  <span class="text-text-primary">{{ selectedTask()!.createdAt | date:'dd.MM.yyyy HH:mm' }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-text-secondary">{{ 'technician.completedAt' | translate }}:</span>
                  <span class="text-text-primary">{{ selectedTask()!.updatedAt | date:'dd.MM.yyyy HH:mm' }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex justify-end pt-4 border-t border-card-border">
            <button
              (click)="onCloseDetailModal()"
              class="px-4 py-2 bg-surface text-text-primary border border-card-border rounded-lg hover:bg-indigo-600 hover:text-white transition-colors"
            >
              {{ 'common.close' | translate }}
            </button>
          </div>
        </div>
      }
    </div>
  </app-modal>

</app-main-layout>
